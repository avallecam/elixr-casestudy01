---
title: "02-standardize_plates"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# packages

```{r,echo=TRUE,warning=FALSE,message=FALSE}
library(tidyverse)
theme_set(theme_bw())
```

# import plates in long-format

```{r}
data4 <- read_rds("data/multiplate-long.rds")

data4 %>% 
  # epihelper::print_inf() %>% 
  identity()
```

# create standardization dataframe

```{r}
std_reference <- 
  tribble(
    ~dilution,~reciprocal,~factor,~abunits,
    "STD 1/50",50,"102400/50",NA_real_,
    "STD 1/100",100,"102400/100",NA_real_,
    "STD 1/200",200,"102400/200",NA_real_,
    "STD 1/400",400,"102400/400",NA_real_,
    "STD 1/800",800,"102400/800",NA_real_,
    "STD 1/1600",1600,"102400/1600",NA_real_,
    "STD 1/3200",3200,"102400/3200",NA_real_,
    "STD 1/6400",6400,"102400/6400",NA_real_,
    "STD 1/12800",12800,"102400/12800",NA_real_,
    "STD 1/25600",25600,"102400/25600",NA_real_,
    "STD 1/51200",51200,"102400/51200",NA_real_,
    "STD 1/102400",102400,"102400/102400",NA_real_,
  ) %>% 
  mutate(abunits=max(reciprocal)/reciprocal)

std_reference
```

# build density ~ abunit relationship

## isolate standard curves

```{r}
data5 <- data4 %>% 
  filter(str_detect(codigo,"STD")) %>% 
  left_join(std_reference,by = c("codigo"="dilution"))

data5 %>% 
  # epihelper::print_inf() %>%
  identity()
```

```{r}
data6 <- data4 %>% 
  filter(str_detect(codigo,"ctrl"))
```

## descriptive

```{r,fig.height=10,fig.width=10}
data5 %>% 
  ggplot(aes(x = abunits,y = densidad)) +
  geom_point() +
  # geom_smooth() +
  geom_hline(aes(yintercept=densidad, color = codigo),
             data = data6) +
  scale_x_log10() +
  facet_wrap(~plate+experimento)
```

## log-logistic model

- [pending]

```{r}

```

# quality control of replicates

## replicates per plate

- how many sample replicates are in each plate?

```{r,message=FALSE}
data4 %>% 
  filter(!str_detect(codigo,"STD|ctrl")) %>% 
  count(plate,experimento,codigo,sort = T) %>% 
  count(n)

data4 %>% 
  filter(!str_detect(codigo,"STD|ctrl")) %>% 
  count(plate,experimento,codigo,sort = T) %>% 
  # epihelper::print_inf() %>% 
  identity()
```

## replicates all plate

- how many sample replicates are in all plates?

```{r,message=FALSE}
data4 %>% 
  filter(!str_detect(codigo,"STD|ctrl")) %>% 
  count(codigo,sort = T) %>% 
  count(n)

data4 %>% 
  filter(!str_detect(codigo,"STD|ctrl")) %>% 
  count(codigo,sort = T)
```

## replicate type

```{r}
data4 %>% 
  filter(str_detect(codigo,"ctrl")) %>% 
  count(plate,experimento,codigo) %>% 
  identity()
  # group_by(plate,experimento,codigo) %>% 
  # skimr::skim(n)
```


## replicate variability

```{r}
data7 <- data4 %>% 
  # filter(!str_detect(codigo,"STD|ctrl")) %>% 
  filter(!str_detect(codigo,"STD")) %>% 
  group_by(plate,experimento,codigo) %>% 
  summarise(densidad_mean=mean(densidad),
            densidad_sd=sd(densidad)) %>% 
  ungroup() %>% 
  mutate(densidad_cv=100*densidad_sd/densidad_mean) %>% 
  # epihelper::print_inf() %>% 
  identity()

data7
```

### identify outliers

```{r}
data8 <- data7 %>% 
  filter(densidad_mean>900)

data8
```

```{r}
data8 %>% 
  select(plate,codigo)
data4 %>% 
  filter(magrittr::is_in(
    x = plate,
    table = data8 %>% pull(plate))) %>% 
  filter(magrittr::is_in(
    x = codigo,
    table = data8 %>% pull(codigo)))
```


### distribution table

#### con outlier

```{r}
data7 %>% 
  select(starts_with("densidad")) %>% 
  skimr::skim() %>% 
  skimr::yank(skim_type = "numeric")
```

#### sin outlier

```{r}
data7 %>% 
  filter(densidad_mean<900) %>% 
  select(starts_with("densidad")) %>% 
  skimr::skim() %>% 
  skimr::yank(skim_type = "numeric")
```

### distribution plot

#### con outlier

```{r,fig.height=10,fig.width=10}
data7 %>% 
  ggplot(aes(x = densidad_mean,y = densidad_cv)) +
  geom_point() +
  geom_hline(aes(yintercept=20),
             linetype="dashed",size=0.3) +
  geom_vline(aes(xintercept=0.25),
             linetype="dashed",size=0.3) +
  coord_cartesian(ylim = c(0,100)) +
  facet_wrap(~plate+experimento)
```

#### sin outlier

```{r,fig.height=10,fig.width=10}
data7 %>% 
  filter(densidad_mean<900) %>% 
  ggplot(aes(x = densidad_mean,y = densidad_cv)) +
  geom_point() +
  geom_hline(aes(yintercept=20),
             linetype="dashed",size=0.3) +
  geom_vline(aes(xintercept=0.25),
             linetype="dashed",size=0.3) +
  coord_cartesian(ylim = c(0,100)) +
  facet_wrap(~plate+experimento)
```

# view plate shape

```{r,eval=FALSE}
plater::view_plate(
  data = data4 %>% filter(plate=="placa_001"), 
  well_ids_column = "pozo", 
  columns_to_display = c("codigo","densidad")
)

plater::view_plate(
  data = data4 %>% filter(plate=="placa_002"), 
  well_ids_column = "pozo", 
  columns_to_display = c("codigo","densidad")
)
```

# output data sets

```{r}
data9 <- data4 %>% 
  filter(!str_detect(codigo,"STD")) #%>% 
  # filter(str_detect(codigo,"ctrl"))
```

```{r,eval=FALSE}
# data4 # all 
# only std + density ~ abunits
data5 %>% write_rds("data/02-data-standard_curve.rds") 
# data6 # only ctrl
# samples and ctrl with stat measurements per code
data7 %>% write_rds("data/02-data-ab_mean.rds") 
# data8 # outliers if any
# data9 # only samples and ctrl
```


