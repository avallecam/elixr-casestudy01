---
title: "05-serological_classification"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# packages

```{r,echo=TRUE,warning=FALSE,message=FALSE}
library(tidyverse)
library(mixtools)
library(patchwork)
library(conflicted)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
```

```{r}
options(scipen=10000)
```

# import input data

```{r}
data_output_03 <- read_rds("data/03-data-ab_units-complete.rds")
```

## extract antibody units estimates

```{r}
data_output_03_abunit <- data_output_03 %>%
  dplyr::select(plate,experimento,estimation) %>% 
  unnest(cols = estimation) %>% 
  
  # extra code to create unique id
  mutate(unique_id = paste0(#experimento,"-",
                            plate,"-",codigo))
```

```{r,eval=FALSE,echo=FALSE}
# data_output_03
# data_output_03_abunit %>% 
#   filter(experimento!="igg_______") %>% 
#   distinct(plate,codigo)
```

```{r}
data_output_03_abunit %>% rmarkdown::paged_table()
```

## reminder

observations are unique when stratified by `experimento` and combined by `plate`, `codigo`:

```{r}
data_output_03_abunit %>% 
  filter(str_detect(codigo,"ctrl_")) %>% 
  filter(magrittr::is_in(plate,c("placa_001","placa_002"))) %>% 
  select(experimento,unique_id) %>% 
  arrange(experimento)
```

# explore data

## antibody distribution in sample

```{r,fig.height=6,fig.width=6,warning=FALSE}
fig01_a <- data_output_03_abunit %>% 
  ggplot(aes(x = estimate)) +
  geom_density(alpha=.5, 
               position = "identity") +
  geom_histogram(aes(y = after_stat(density)),
                 bins = 60,
                 alpha=.5, 
                 position = "identity") +
  facet_grid(~experimento,scales = "free") +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title="AU linear distribution")

fig01_b <- data_output_03_abunit %>% 
  ggplot(aes(sample = estimate)) +
  geom_qq(alpha=.2) +
  geom_qq_line(line.p = c(0.25, 0.75)) +
  facet_grid(~experimento,scales = "free") +
  labs(title="Gaussian quantile-quantile plot") +
  coord_cartesian(ylim = c(0,2000))

fig01_a / fig01_b
```

## identify missing values

```{r}
data_output_03_abunit %>% 
  select(experimento,unique_id,estimate) %>% 
  naniar::vis_miss()
```


# fit a gaussian mixture model

Use `mixtools` package following the blog post about [Using Mixture Models for Clustering](https://tinyheero.github.io/2015/10/13/mixture-model.html)

Use it for two `experimento` and at least two `k-component` variations `k=2` and `k=3`

## for one strata

```{r}
data_output_03_abunit %>% 
  select(experimento,estimate) %>% 
  filter(!is.na(estimate)) %>% 
  filter(experimento=="igg") %>% 
  pull(estimate) %>% 
  normalmixEM(k=2) %>% 
  class()
```

## for all stratas and all components

```{r}
model_output_01 <- data_output_03_abunit %>% 
  # filter(experimento=="igg") %>% 
  select(experimento,unique_id,estimate) %>% 
  filter(!is.na(estimate)) %>% 
  group_by(experimento) %>% 
  nest() %>% 
  ungroup() %>%
  mutate(estimate_strata = map(data,pull,estimate)) %>% 
  # expand the grid by the combination of k components
  expand_grid(component_n = 2:5) %>%
  mutate(mixture_model = 
           pmap(.l = 
                  select(
                    .,
                    x = estimate_strata,
                    k = component_n
                  ),
                .f = normalmixEM)) %>% 
  # extract the log likelihood
  mutate(loglikelihood = map_dbl(mixture_model,pluck,"loglik")) %>% 
  # compute the aic
  mutate(aic=2*component_n-2*loglikelihood) %>% 
  group_by(experimento) %>% 
  mutate(aic_difference = aic - dplyr::lag(aic)) %>% 
  ungroup()

# model_output_01
```

## criteria for model selection

criteria to choose the number of `k-compartments` for a distribution:

- not based only on AIC criteria, but also in visual inspection of the distribution
- minimize the number of undetermined samples (`s0`)
- closer resemblance to the expected number of positives

## summary of model performance

```{r}
model_output_01 %>% 
  select(experimento,component_n,loglikelihood,aic,aic_difference)
```


## visualize mixture model performance

### function to plot mixture components

```{r}
#' Plot a Mixture Component
#' 
#' @param x Input data
#' @param mu Mean of component
#' @param sigma Standard deviation of component
#' @param lam Mixture weight of component
plot_mix_comps <- function(x, mu, sigma, lam) {
  lam * dnorm(x, mu, sigma)
}

stat_mixture <- function(model_name, k_component, colour) {
  stat_function(geom = "line", fun = plot_mix_comps,
                args = list(model_name$mu[k_component], 
                            model_name$sigma[k_component], 
                            lam = model_name$lambda[k_component]),
                colour = colour, lwd = 1.5)
}
```

components distributions equivalent to multiple latent seropositive states:

| component|     color|     state|
|:---------|:---------|:---------|
|    comp.1|       red|        s-|
|    comp.2|      blue|        s+|
|    comp.3|     green|       s++|

### experiment 1

```{r}
model_igg_k2 <- model_output_01 %>% 
  filter(experimento == "igg",
         component_n == 2) %>% 
  pull(mixture_model) %>% 
  pluck(1)

fig02a <- data.frame(x = model_igg_k2$x) %>%
  ggplot() +
  geom_histogram(aes(x, after_stat(density)), 
                 bins = 30,
                 alpha=.5,
                 position = "identity") +
  stat_mixture(model_name = model_igg_k2,k_component = 1,colour = "red") +
  stat_mixture(model_name = model_igg_k2,k_component = 2,colour = "blue")
```

```{r}
model_igg_k3 <- model_output_01 %>% 
  filter(experimento == "igg",
         component_n == 3) %>% 
  pull(mixture_model) %>% 
  pluck(1)

fig02b <- data.frame(x = model_igg_k3$x) %>%
  ggplot() +
  geom_histogram(aes(x, after_stat(density)), 
                 bins = 30,
                 alpha=.5,
                 position = "identity") +
  stat_mixture(model_name = model_igg_k3,k_component = 1,colour = "red") +
  stat_mixture(model_name = model_igg_k3,k_component = 2,colour = "blue") +
  stat_mixture(model_name = model_igg_k3,k_component = 3,colour = "green")
```

```{r,fig.height=3,fig.width=7}
fig02a + fig02b
```

### experiment 2

```{r}
model_avi_k2 <- model_output_01 %>% 
  filter(experimento == "igg-avidez",
         component_n == 2) %>% 
  pull(mixture_model) %>% 
  pluck(1)

fig03a <- data.frame(x = model_avi_k2$x) %>%
  ggplot() +
  geom_histogram(aes(x, after_stat(density)), 
                 bins = 30,
                 alpha=.5,
                 position = "identity") +
  stat_mixture(model_name = model_avi_k2,k_component = 1,colour = "red") +
  stat_mixture(model_name = model_avi_k2,k_component = 2,colour = "blue")
```

```{r}
model_avi_k3 <- model_output_01 %>% 
  filter(experimento == "igg-avidez",
         component_n == 3) %>% 
  pull(mixture_model) %>% 
  pluck(1)

fig03b <- data.frame(x = model_avi_k3$x) %>%
  ggplot() +
  geom_histogram(aes(x, after_stat(density)), 
                 bins = 30,
                 alpha=.5,
                 position = "identity") +
  stat_mixture(model_name = model_avi_k3,k_component = 1,colour = "red") +
  stat_mixture(model_name = model_avi_k3,k_component = 2,colour = "blue") +
  stat_mixture(model_name = model_avi_k3,k_component = 3,colour = "green")
```

```{r,fig.height=3,fig.width=7}
fig03a + fig03b
```


# classify seropositivity

## classify using threshhold

```{r}
class_probability <- 0.90

data_output_04 <- model_output_01 %>% 
  filter(magrittr::is_in(component_n,c(2,3))) %>% 
  select(experimento,data,component_n,mixture_model) %>% 
  mutate(mixture_components = map(
    .x = mixture_model,
    .f = pluck, "posterior")) %>%
  mutate(mixture_components = map(
    .x = mixture_components, 
    .f = as_tibble)) %>% 
  select(-mixture_model) %>% 
  unnest(cols = c(data,component_n,mixture_components)) %>% 
  # # quality control
  # count(experimento,component_n)
  # rowwise to securily sum numbers removing missing values
  rowwise() %>% 
  mutate(comp.23 = sum(c_across(cols = c(comp.2,comp.3)),na.rm = T)) %>% 
  ungroup() %>% 
  mutate(class = case_when(
    comp.1 > class_probability ~ "s-",
    comp.2 > class_probability ~ "s+",
    comp.3 > class_probability ~ "s++",
    TRUE ~ "s0"
  )) %>% 
  mutate(class_two = case_when(
    comp.1 > class_probability ~ "s-",
    comp.23 > class_probability ~ "s+",
    TRUE ~ "s0"
  )) %>% 
  mutate(class = fct_relevel(class, "s-","s0","s+","s++")) %>% 
  mutate(class_two = fct_relevel(class_two, "s-","s0","s+"))
```

```{r}
data_output_04 %>% rmarkdown::paged_table()
```

```{r,eval=FALSE,echo=FALSE}
# quality control
# all prob must sum 1
data_output_04 %>% 
  select(starts_with("comp.")) %>% 
  rowwise() %>% 
  mutate(sum = sum(c_across(cols = -comp.23),na.rm = T)) %>% 
  ungroup() %>% 
  select(sum) %>% 
  summary()
```


## summary of classification

```{r}
data_output_04 %>% 
  count(experimento,component_n,class)

data_output_04 %>% 
  count(experimento,component_n,class_two)
```

## visualize classification

### by distribution

```{r,fig.height=5,fig.width=8}
data_output_04 %>% 
  ggplot(aes(x = estimate, 
             fill = class, 
             after_stat(density))) +
  geom_histogram(binwidth = 50,
                 alpha=.5,
                 position = "identity") +
  facet_wrap(~experimento+component_n,scales = "free")

data_output_04 %>% 
  ggplot(aes(x = estimate,
             fill = class_two, 
             after_stat(density))) +
  geom_histogram(binwidth = 50,
                 alpha=.5,
                 position = "identity") +
  facet_wrap(~experimento+component_n,scales = "free")
```

### by frecuency

```{r,fig.height=5,fig.width=6}
data_output_04 %>% 
  ggplot(aes(x = class)) +
  geom_bar() +
  facet_wrap(~experimento+component_n)

data_output_04 %>% 
  ggplot(aes(x = class_two)) +
  geom_bar() +
  facet_wrap(~experimento+component_n)
```

### by classification probability

```{r,fig.height=5,fig.width=7}
data_output_04 %>% 
  ggplot() +
  geom_line(aes(x = estimate,y = comp.1), colour="red", lwd = 1.5) +
  geom_line(aes(x = estimate,y = comp.2), colour="blue", lwd = 1.5) +
  geom_line(aes(x = estimate,y = comp.3), colour="green", lwd = 1.5) +
  geom_hline(yintercept = class_probability, col = "black") +
  facet_wrap(~experimento+component_n,scales = "free")

data_output_04 %>% 
  ggplot() +
  geom_line(aes(x = estimate,y = comp.1), colour="red", lwd = 1.5) +
  geom_line(aes(x = estimate,y = comp.23), colour="blue", lwd = 1.5) +
  geom_hline(yintercept = class_probability, col = "black") +
  facet_wrap(~experimento+component_n,scales = "free")
```

# to do list

- [ ] clean output data table number in components
- [ ] export final table to user
- [ ] compare traditional vs data-base classification
- [ ] replace density plots by automatic color based plots
- [ ] remove redundant n=3 plots

